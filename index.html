<!doctype html>
<html data-theme="light">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>GRANULAR - Rural typology</title>
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <style>
     body {
       width: 100%;
       height: 100%;
       margin: 0;
       padding: 0;
     }
     html {
       height: 100%;
     }
     #map {
       width: 100%;
       height: 100%;
     }

     #loader {
       position: absolute;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background: rgba(255, 255, 255, 0.9);
       display: flex;
       flex-direction: column;
       justify-content: center;
       align-items: center;
       z-index: 999;
       transition: opacity 0.5s ease-out;
     }

     #loader.hidden {
       opacity: 0;
       pointer-events: none;
     }

     .loader-content {
       text-align: center;
       color: #3D7454;
       font-family: 'Montserrat', sans-serif;
     }

     .spinner {
       width: 50px;
       height: 50px;
       border: 4px solid rgba(61, 116, 84, 0.2);
       border-top: 4px solid #f4c01e;
       border-radius: 50%;
       animation: spin 1s linear infinite;
       margin: 0 auto 20px;
     }

     @keyframes spin {
       0% { transform: rotate(0deg); }
       100% { transform: rotate(360deg); }
     }

     .loader-text {
       font-size: 16px;
       font-weight: 600;
       margin-bottom: 8px;
     }

     .loader-subtext {
       font-size: 12px;
       opacity: 0.9;
     }

     .maplibregl-popup-content {
       font-family: 'Montserrat', sans-serif;
       font-size: 12px;
       background-color: #f4c01e !important;
       color: white !important;
     }
     .maplibregl-popup-close-button {
       color: white;
     }

     .control-panel {
       position: absolute;
       top: 10px;
       right: 10px;
       background: white;
       padding: 12px;
       border-radius: 8px;
       box-shadow: 0 2px 10px rgba(0,0,0,0.1);
       font-family: 'Montserrat', sans-serif;
       z-index: 1;
       width: 380px;
       max-height: 90vh;
       overflow-y: auto;
     }

     .control-panel .logo {
       width: 100%;
       max-width: 180px;
       margin-top: 5px;
       margin-bottom: 12px;
       display: block;
     }

     .info-section {
       margin-bottom: 12px;
       padding-bottom: 10px;
       border-bottom: 1px solid #eee;
     }

     .info-section h3 {
       margin: 0 0 6px 0;
       font-size: 13px;
       font-weight: 600;
       color: #3D7454;
     }

     .info-section p {
       font-size: 10px;
       line-height: 1.4;
       color: #555;
       margin: 0;
     }

     .control-panel h3 {
       margin: 0 0 8px 0;
       font-size: 13px;
       font-weight: 600;
       color: #333;
     }

     .control-group {
       margin-bottom: 12px;
       padding-bottom: 12px;
       border-bottom: 1px solid #eee;
     }

     .control-group:last-child {
       border-bottom: none;
       padding-bottom: 0;
     }

     .control-group label {
       display: block;
       font-size: 11px;
       color: #666;
       margin-bottom: 5px;
     }

     .control-group input[type="range"] {
       width: 100%;
       cursor: pointer;
       -webkit-appearance: none;
       appearance: none;
       height: 6px;
       background: #ddd;
       border-radius: 3px;
       outline: none;
     }

     .control-group input[type="range"]::-webkit-slider-thumb {
       -webkit-appearance: none;
       appearance: none;
       width: 18px;
       height: 18px;
       background: #f4c01e;
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }

     .control-group input[type="range"]::-moz-range-thumb {
       width: 18px;
       height: 18px;
       background: #f4c01e;
       border-radius: 50%;
       cursor: pointer;
       border: 2px solid white;
       box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }

     .control-group .value-display {
       display: inline-block;
       font-size: 11px;
       color: #333;
       font-weight: 600;
       margin-left: 5px;
     }

     /* Group toggle styles */
     .group-toggle {
       margin-bottom: 8px;
       padding: 6px;
       background-color: #f9f9f9;
       border-radius: 4px;
     }

     .group-toggle-header {
       display: flex;
       align-items: center;
       margin-bottom: 6px;
       font-weight: 600;
       font-size: 11px;
       color: #333;
     }

     .group-toggle-header input[type="checkbox"] {
       margin-right: 6px;
       cursor: pointer;
       width: 15px;
       height: 15px;
       flex-shrink: 0;
     }

     .group-toggle-header span {
       line-height: 1.3;
     }

     .group-classes {
       padding-left: 20px;
     }

     /* Class toggle styles */
     .class-toggle {
       display: flex;
       align-items: center;
       margin-bottom: 4px;
       padding: 3px;
       border-radius: 4px;
       transition: background-color 0.2s;
     }

     .class-toggle:hover {
       background-color: #f5f5f5;
     }

     .class-toggle input[type="checkbox"] {
       margin-right: 6px;
       cursor: pointer;
       width: 13px;
       height: 13px;
       flex-shrink: 0;
     }

     .class-color {
       width: 13px;
       height: 13px;
       border-radius: 3px;
       margin-right: 6px;
       border: 1px solid rgba(0,0,0,0.1);
       flex-shrink: 0;
     }

     .class-label {
       font-size: 10px;
       color: #555;
       flex: 1;
       line-height: 1.3;
     }
    </style>
  </head>
  <body>
    <div id="map">

      <div id="loader">
        <div class="loader-content">
          <div class="spinner"></div>
          <div class="loader-text">Loading map</div>
          <div class="loader-subtext">Preparing grid data...</div>
        </div>
      </div>
    </div>

    <div class="control-panel">
      <img src="img/logo-granular-2x.svg" class="logo">

      <div class="info-section">
        <h3>Rural Typology</h3>
        <p>
          This typology builds on DEGURBA to reveal greater diversity within rural areas, operating within each rural class to add nuance to the established classification.
        </p>
        <p style="margin-top: 6px; margin-bottom: 6px;">
          <a href="note.html" style="color: #3D7454; text-decoration: none; border-bottom: 1px solid #9DC567; font-size: 10px;">Read the methodology</a>
        </p>

        <p>
          Use the <strong>opacity slider</strong> to adjust transparency and see the underlying basemap. Toggle <strong>class checkboxes</strong> to compare different rural types and explore spatial patterns across Europe.
        </p>
      </div>

      <div class="control-group">
        <label>
          Opacity: <span class="value-display" id="opacity-value">50%</span>
        </label>
        <input
          type="range"
          id="opacity-slider"
          min="0"
          max="100"
          value="50"
        />
      </div>

      <div class="control-group">
        <!-- DEGURBA 11 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-11" checked>
            <span>Mostly uninhabited areas or very dispersed rural area</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_0" value="degurba_11_class_0" checked>
              <div class="class-color" style="background-color: #e8dcc8;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_1" value="degurba_11_class_1" checked>
              <div class="class-color" style="background-color: #8e9ac3;"></div>
              <span class="class-label">Class 1</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_2" value="degurba_11_class_2" checked>
              <div class="class-color" style="background-color: #6d5533;"></div>
              <span class="class-label">Class 2</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_3" value="degurba_11_class_3" checked>
              <div class="class-color" style="background-color: #c97d84;"></div>
              <span class="class-label">Class 3</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_11_class_4" value="degurba_11_class_4" checked>
              <div class="class-color" style="background-color: #d6a54d;"></div>
              <span class="class-label">Class 4</span>
            </div>
          </div>
        </div>

        <!-- DEGURBA 12 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-12">
            <span>Dispersed rural areas</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_12_class_0" value="degurba_12_class_0">
              <div class="class-color" style="background-color: #9bc993;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_12_class_1" value="degurba_12_class_1">
              <div class="class-color" style="background-color: #5a9b4d;"></div>
              <span class="class-label">Class 1</span>
            </div>
          </div>
        </div>

        <!-- DEGURBA 13 Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-13">
            <span>Villages</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_13_class_0" value="degurba_13_class_0">
              <div class="class-color" style="background-color: #96b9c9;"></div>
              <span class="class-label">Class 0</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_13_class_1" value="degurba_13_class_1">
              <div class="class-color" style="background-color: #2b6ea6;"></div>
              <span class="class-label">Class 1</span>
            </div>
          </div>
        </div>

        <!-- DEGURBA Urban Group -->
        <div class="group-toggle">
          <div class="group-toggle-header">
            <input type="checkbox" id="group-degurba-urban">
            <span>Urban areas</span>
          </div>
          <div class="group-classes">
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_urban_class_21" value="degurba_urban_class_21">
              <div class="class-color" style="background-color: #e67e50;"></div>
              <span class="class-label">Suburban or peri-urban area</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_urban_class_22" value="degurba_urban_class_22">
              <div class="class-color" style="background-color: #d85a2a;"></div>
              <span class="class-label">Semi-dense town</span>
            </div>
            <div class="class-toggle">
              <input type="checkbox" id="class-degurba_urban_class_30" value="degurba_urban_class_30">
              <div class="class-color" style="background-color: #b83232;"></div>
              <span class="class-label">City</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
     // Get loader element
     const loader = document.getElementById('loader');

     // Register PMTiles protocol
     let protocol = new pmtiles.Protocol();
     maplibregl.addProtocol("pmtiles", protocol.tile);

     const map = new maplibregl.Map({
       container: 'map',
       style: "https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",
       center: [2.8948, 42.6886],
       zoom: 9,
       minZoom: 0,
       maxZoom: 14,
     });

     map.addControl(new maplibregl.NavigationControl(), 'top-left');

     // Track loading state
     let tilesLoaded = false;
     let dataLoaded = false;

     function checkAndHideLoader() {
       if (tilesLoaded && dataLoaded) {
         setTimeout(() => {
           loader.classList.add('hidden');
           setTimeout(() => {
             loader.style.display = 'none';
           }, 500);
         }, 300);
       }
     }

     map.on('load', () => {
       dataLoaded = true;

       // PMTiles source
       map.addSource('polygons', {
         type: 'vector',
         url: 'pmtiles://layers/polygons.pmtiles',
       });

       map.addLayer({
         id: 'polygons-fill',
         type: 'fill',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'fill-color': [
             'match',
             ['get', 'cluster_info'],
             'degurba_11_class_0', '#e8dcc8',
             'degurba_11_class_1', '#8e9ac3',
             'degurba_11_class_2', '#6d5533',
             'degurba_11_class_3', '#c97d84',
             'degurba_11_class_4', '#d6a54d',

             'degurba_12_class_0', '#9bc993',
             'degurba_12_class_1', '#5a9b4d',

             'degurba_13_class_0', '#96b9c9',
             'degurba_13_class_1', '#2b6ea6',

             'degurba_urban_class_21', '#e67e50',
             'degurba_urban_class_22', '#d85a2a',
             'degurba_urban_class_30', '#b83232',
             '#e0e0e0' // default (light gray)
           ],
           'fill-opacity': 0.5
         }
       });

       map.addLayer({
         id: 'polygons-line',
         type: 'line',
         source: 'polygons',
         'source-layer': 'polygons',
         paint: {
           'line-color': '#ffffff',
           'line-width': 0.3,
           'line-opacity': 0.3
         }
       });

       const opacitySlider = document.getElementById('opacity-slider');
       const opacityValue = document.getElementById('opacity-value');

       opacitySlider.addEventListener('input', (e) => {
         const opacity = e.target.value / 100;
         opacityValue.textContent = e.target.value + '%';
         map.setPaintProperty('polygons-fill', 'fill-opacity', opacity);
       });

       // Class visibility management
       const visibleClasses = new Set([
         'degurba_11_class_0', 'degurba_11_class_1', 'degurba_11_class_2', 'degurba_11_class_3', 'degurba_11_class_4'
       ]);

       const groupClasses = {
         'degurba-11': ['degurba_11_class_0', 'degurba_11_class_1', 'degurba_11_class_2', 'degurba_11_class_3', 'degurba_11_class_4'],
         'degurba-12': ['degurba_12_class_0', 'degurba_12_class_1'],
         'degurba-13': ['degurba_13_class_0', 'degurba_13_class_1'],
         'degurba-urban': ['degurba_urban_class_21', 'degurba_urban_class_22', 'degurba_urban_class_30']
       };

       function updateFilter() {
         if (visibleClasses.size === 0) {
           map.setLayoutProperty('polygons-fill', 'visibility', 'none');
           map.setLayoutProperty('polygons-line', 'visibility', 'none');
         } else {
           map.setLayoutProperty('polygons-fill', 'visibility', 'visible');
           map.setLayoutProperty('polygons-line', 'visibility', 'visible');

           const filter = ['in', ['get', 'cluster_info'], ['literal', Array.from(visibleClasses)]];
           map.setFilter('polygons-fill', filter);
           map.setFilter('polygons-line', filter);
         }
       }

       // Set initial filter
       updateFilter();

       // Individual class checkboxes
       const allClassCheckboxes = document.querySelectorAll('.class-toggle input[type="checkbox"]');
       allClassCheckboxes.forEach(checkbox => {
         checkbox.addEventListener('change', (e) => {
           const classValue = e.target.value;

           if (e.target.checked) {
             visibleClasses.add(classValue);
           } else {
             visibleClasses.delete(classValue);
           }

           // Update group checkbox state
           const parts = classValue.split('_');
           let group;
           if (parts[0] === 'degurba' && parts[1] === 'urban') {
             group = 'degurba-urban';
           } else {
             group = parts[0] + '-' + parts[1];
           }
           updateGroupCheckbox(group);

           updateFilter();
         });
       });

       // Group checkboxes
       Object.keys(groupClasses).forEach(groupId => {
         const groupCheckbox = document.getElementById(`group-${groupId}`);

         groupCheckbox.addEventListener('change', (e) => {
           const classes = groupClasses[groupId];

           classes.forEach(className => {
             const classCheckbox = document.getElementById(`class-${className}`);
             classCheckbox.checked = e.target.checked;

             if (e.target.checked) {
               visibleClasses.add(className);
             } else {
               visibleClasses.delete(className);
             }
           });

           updateFilter();
         });
       });

       function updateGroupCheckbox(groupId) {
         const groupCheckbox = document.getElementById(`group-${groupId}`);
         const classes = groupClasses[groupId];

         const allChecked = classes.every(cls => visibleClasses.has(cls));
         const someChecked = classes.some(cls => visibleClasses.has(cls));

         groupCheckbox.checked = allChecked;
         groupCheckbox.indeterminate = someChecked && !allChecked;
       }

       map.on('click', 'polygons-fill', (e) => {
         const props = e.features[0].properties;

         new maplibregl.Popup()
                       .setLngLat(e.lngLat)
                       .setHTML(`
             <div>
               <b>${props.cluster_info}</b><br/>
               <small>ID: ${props.GRD_ID}</small>
             </div>
                       `)
                       .addTo(map);
       });

       map.on('mouseenter', 'polygons-fill', () => {
         map.getCanvas().style.cursor = 'pointer';
       });

       map.on('mouseleave', 'polygons-fill', () => {
         map.getCanvas().style.cursor = '';
       });

       checkAndHideLoader();
     });

     // Hide loader when tiles are loaded
     map.on('idle', () => {
       tilesLoaded = true;
       checkAndHideLoader();
     });
    </script>
  </body>
</html>
